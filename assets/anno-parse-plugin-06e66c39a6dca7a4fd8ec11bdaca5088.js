annotorious.plugin.Parse=function(o){this._APP_ID=o.app_id,this._JS_KEY=o.js_key,this._DEBUG=o.debug||!1,this._context=o.context||window.location.href.split("#")[0].split("index.html")[0]+"#",this._collection=null,this._loadIndicators=[]},annotorious.plugin.Parse.prototype.initPlugin=function(o){var e=this;Parse.$=jQuery,Parse.initialize(this._APP_ID,this._JS_KEY);var n=Parse.Object.extend("Annotation"),t=Parse.Collection.extend({model:n,query:new Parse.Query(n).equalTo("context",e._context)});this._collection=new t,o.addHandler("onAnnotationCreated",function(o){e._create(o)}),o.addHandler("onAnnotationUpdated",function(o){e._update(o)}),o.addHandler("onAnnotationRemoved",function(o){e._delete(o)}),e._loadAnnotations(o)},annotorious.plugin.Parse.prototype.onInitAnnotator=function(o){var e=this._newLoadIndicator();o.element.appendChild(e),this._loadIndicators.push(e)},annotorious.plugin.Parse.prototype._newLoadIndicator=function(){var o=document.createElement("div");o.className="annotorious-parse-plugin-load-outer";var e=document.createElement("div");return e.className="annotorious-parse-plugin-load-inner",o.appendChild(e),o},annotorious.plugin.Parse.prototype._loadAnnotations=function(o){var e=this,n=function(){jQuery.each(e._loadIndicators,function(o,e){jQuery(e).remove()})};this._collection.fetch({success:function(t){t.each(function(n){e._DEBUG&&console.log("load success",n),!n.get("shape")&&n.get("shapes")[0].geometry&&o.addAnnotation(n.toJSON())}),n()},error:function(o,t){e._DEBUG&&console.log("load error",o,t),n()}})},annotorious.plugin.Parse.prototype._create=function(o){var e=this,n=Parse.Object.extend("Annotation"),t=new n;t.save(o,{success:function(n){e._DEBUG&&console.log("create success",n),o.objectId=n.id,e._collection.add(t)},error:function(o,n){e._DEBUG&&console.log("create error",o,n)}})},annotorious.plugin.Parse.prototype._update=function(o){var e=this,n=this._collection.get(o.objectId);delete o.objectId,n.save(o,{success:function(n){e._DEBUG&&console.log("update success",n),o.objectId=n.id},error:function(o,n){e._DEBUG&&console.log("update error",o,n)}})},annotorious.plugin.Parse.prototype._delete=function(o){self=this;var e=this._collection.get(o.objectId);e.destroy({success:function(o){self._DEBUG&&console.log("delete success",o)},error:function(o,e){self._DEBUG&&console.log("delete error",o,e)}})};